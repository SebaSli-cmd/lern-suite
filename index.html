<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Lern-Suite V32.3 (Robust Logic)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0052cc">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/brain--v1.png">

    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #0052cc; --primary-dark: #003d99; --bg: #f8fafc; --card-bg: #ffffff;
            --text: #0f172a; --text-muted: #475569; --border: #cbd5e1; --input-bg: #ffffff;
            --header-cell-bg: #f1f5f9; --hover-bg: #e2e8f0; --success: #15803d; --danger: #b91c1c;
            --warning-bg: #fff7ed; --warning-text: #9a3412; --prio-high: #dc2626; --prio-mid: #d97706; --prio-low: #16a34a;
            --chart-done: #22c55e; --grade-bg: #ecfccb; --grade-text: #365314;
        }
        body.dark-mode {
            --primary: #60a5fa; --primary-dark: #3b82f6; --bg: #0f172a; --card-bg: #1e293b;
            --text: #f8fafc; --text-muted: #cbd5e1; --border: #475569; --input-bg: #020617;
            --header-cell-bg: #1e293b; --hover-bg: #334155; --warning-bg: #451a03; --warning-text: #fb923c;
            --grade-bg: #3f6212; --grade-text: #ecfccb;
        }

        /* --- BASE --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 140px; line-height: 1.5; -webkit-tap-highlight-color: transparent; }
        input, select, textarea { font-size: 16px !important; outline: none; }
        
        /* --- COMPONENTS --- */
        .suite-header { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 15px; }
        .header-top { display: flex; flex-direction: column; gap: 10px; }
        @media (min-width: 600px) { .header-top { flex-direction: row; justify-content: space-between; align-items: center; } }
        .header-info h1 { margin: 0; font-size: 1.4rem; }
        .header-controls-wrapper { display: flex; gap: 8px; align-items: center; }
        
        .btn-icon { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .btn-icon:hover { background: rgba(255,255,255,0.3); }
        .btn-icon.sm { width: 32px; font-size: 0.9rem; }
        #examSelect { flex-grow: 1; padding: 0 10px; border-radius: 6px; border: none; font-weight: bold; color: #333; height: 36px; cursor: pointer; }

        .tabs { display: flex; gap: 5px; overflow-x: auto; margin-top: 15px; padding-bottom: 2px; }
        .tab-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* --- VIEWS --- */
        .phase-display { background: var(--card-bg); padding: 15px; border-radius: 12px; border-left: 5px solid var(--primary); margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .btn-magic { background: linear-gradient(135deg, #7c3aed, #db2777); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; margin-bottom: 15px; cursor: pointer; transition: transform 0.1s; }
        .btn-magic:active { transform: scale(0.98); }
        
        .task-list { display: flex; flex-direction: column; gap: 8px; }
        .cockpit-card { background: var(--card-bg); padding: 12px; border-radius: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: opacity 0.3s ease; }
        .check-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border); background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: transparent; font-size: 1.2rem; transition: all 0.2s; }
        .check-btn:hover { border-color: var(--success); color: var(--success); }
        .check-btn.checked { background: var(--success); border-color: var(--success); color: white; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.02); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .chart-container { position: relative; width: 160px; height: 160px; border-radius: 50%; background: conic-gradient(var(--chart-done) 0deg, var(--border) 0deg 360deg); display: flex; align-items: center; justify-content: center; margin-bottom: 15px; transition: background 0.5s ease; }
        .chart-inner { width: 120px; height: 120px; background: var(--card-bg); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .chart-value { font-size: 1.8rem; font-weight: 800; color: var(--text); }
        
        .gpa-box { background: var(--grade-bg); color: var(--grade-text); padding: 15px; border-radius: 12px; width: 100%; margin-top: 10px; text-align: center; font-weight: bold; border: 1px solid var(--border); }
        .module-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .module-table th { text-align: left; color: var(--text-muted); padding: 5px; border-bottom: 1px solid var(--border); }
        .module-table td { padding: 8px 5px; border-bottom: 1px solid var(--border); }
        .module-table input { width: 50px; padding: 5px; border-radius: 4px; border: 1px solid var(--border); text-align: center; background: rgba(255,255,255,0.5); }
        .progress-row { margin-bottom: 12px; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        .progress-track { width: 100%; height: 10px; background: var(--hover-bg); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.8s ease; }
        .stat-list-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.95rem; }

        .filter-row { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; background: var(--header-cell-bg); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .filter-select { flex-grow: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-weight: bold; cursor: pointer; }
        #wbsTreeContainer { display: flex; flex-direction: column; gap: 10px; }
        details.tree-level-1 { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        details.tree-level-1 > summary { padding: 12px; background: var(--header-cell-bg); font-weight: bold; cursor: pointer; list-style: none; display: flex; justify-content: space-between; }
        details.tree-level-1 > summary::-webkit-details-marker { display: none; }
        details.tree-level-2 { border-top: 1px solid var(--border); }
        details.tree-level-2 > summary { padding: 10px 12px; font-weight: 600; cursor: pointer; color: var(--primary); background: var(--card-bg); display: flex; align-items: center; gap: 8px; }
        
        .tree-item { display: grid; grid-template-columns: 25px 1fr auto; gap: 10px; align-items: center; background: var(--card-bg); padding: 8px 12px; border-top: 1px solid var(--border); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; cursor: pointer; margin: 0 auto; transition: transform 0.2s; }
        .status-dot:hover { transform: scale(1.2); }
        .status-dot.todo { background: var(--danger); }
        .status-dot.doing { background: var(--warning-text); }
        .status-dot.done { background: var(--success); }
        .item-input { width: 100%; border: none; background: transparent; font-weight: 500; color: var(--text); padding: 2px 0; }
        .item-input:focus { border-bottom: 1px solid var(--primary); }
        .item-meta-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .mini-select { border: none; background: transparent; font-size: inherit; color: inherit; font-weight: 600; cursor: pointer; padding: 0; }
        .mini-input { border: none; background: transparent; font-size: inherit; color: inherit; width: 30px; text-align: center; border-bottom: 1px dashed var(--border); }
        .prio-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:2px; flex-shrink:0; }
        .action-btn { width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 6px; background: white; color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .action-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--hover-bg); }
        .action-btn.del:hover { border-color: var(--danger); color: var(--danger); background: #fee2e2; }

        .gantt-box { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; padding: 10px; margin-bottom: 20px; }
        .gantt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .gantt-zoom-select { padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 0.8rem; }
        .timeline { position: relative; min-height: 50px; padding: 10px 0; }
        .bar-row { height: 25px; margin-bottom: 5px; position: relative; }
        .bar { position: absolute; height: 20px; background: var(--primary); border-radius: 4px; color: white; font-size: 0.7rem; display: flex; align-items: center; padding-left: 5px; opacity: 0.8; white-space: nowrap; overflow: hidden;}
        .today-line { position: absolute; top:0; bottom:0; width: 2px; background: var(--danger); z-index: 10; }
        .agenda-item { background: var(--card-bg); padding: 10px; border-radius: 8px; border-left: 4px solid var(--text-muted); margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; }

        .footer-tools { margin-top: 40px; text-align: center; display: flex; flex-direction: column; gap: 10px; opacity: 0.9; }
        .footer-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .footer-link { border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px; color: var(--text); text-decoration: none; font-size: 0.85rem; background: var(--card-bg); cursor: pointer; transition: all 0.2s; }
        .footer-link:hover { border-color: var(--primary); color: var(--primary); }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(2px); }
        .modal-card { background: var(--card-bg); width: 100%; max-width: 400px; padding: 25px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .template-btn { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 8px; text-align: left; background: var(--bg); cursor: pointer; color: var(--text); font-weight: bold; transition: background 0.2s; }
        .template-btn:hover { background: var(--hover-bg); }
        /* Add box-sizing to fix overflow */
        .file-upload-label { display: block; width: 100%; padding: 15px; border: 2px dashed var(--primary); border-radius: 8px; text-align: center; color: var(--primary); cursor: pointer; margin-bottom: 10px; font-weight: bold; background: var(--hover-bg); box-sizing: border-box; }
        .file-upload-label:hover { background: #e0f2fe; }
        
        .guide-box { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .guide-box:last-child { border-bottom: none; }
        .guide-title { font-size: 1rem; font-weight: bold; margin-bottom: 8px; color: var(--primary); }
        .guide-text { font-size: 0.9rem; line-height: 1.5; color: var(--text); }
        .guide-tip { background: var(--input-bg); padding: 10px; border-left: 3px solid var(--warning-text); border-radius: 4px; margin-top: 10px; font-size: 0.85rem; font-style: italic; }

        #toast { visibility: hidden; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; z-index: 3000; font-size: 0.9rem; }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
    </style>
</head>
<body>

    <div class="suite-header">
        <div class="header-top">
            <div class="header-info">
                <h1>üéì Lern-Suite V32.3</h1>
                <p id="modeBadge">Azubi Edition</p>
            </div>
            <div class="header-controls-wrapper">
                <button class="btn-icon" id="btnToggleDark">üåô</button>
                <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:8px; display:flex; gap:4px; flex-grow:1;">
                    <select id="examSelect"></select>
                    <button class="btn-icon sm" id="btnEditExam" title="Datum √§ndern">‚úèÔ∏è</button>
                    <button class="btn-icon sm" id="btnAddExam" title="Neu">+</button>
                </div>
            </div>
        </div>
        
        <div class="tabs" id="mainTabs">
            <button class="tab-btn active" data-tab="cockpit">üöÄ Cockpit</button>
            <button class="tab-btn" data-tab="plan">üìÖ Zeitplan</button>
            <button class="tab-btn" data-tab="stats">üìä Stats</button>
            <button class="tab-btn" data-tab="backlog">üìö Katalog</button>
            <button class="tab-btn" data-tab="info">‚ÑπÔ∏è Info</button>
        </div>
    </div>

    <!-- VIEWS -->
    <div id="tab-cockpit" class="tab-content active">
        <div class="phase-display">
            <div><strong>Aktuelle Phase</strong><div style="font-size:0.8rem; opacity:0.7" id="daysLeft">...</div></div>
            <div id="progressText" style="font-weight:bold; color:var(--primary)">0%</div>
        </div>
        <button class="btn-magic" id="btnAutoFill">ü™Ñ Smart Auto-Fill (Lernplan f√ºllen)</button>
        <div id="cockpitList" class="task-list"></div>
        <div id="emptyCockpit" style="text-align:center; padding:30px; display:none; color:var(--text-muted)">Nichts zu tun. Hol dir Aufgaben aus dem Katalog.</div>
    </div>

    <div id="tab-plan" class="tab-content">
        <div class="gantt-box">
            <div class="gantt-header">
                <strong>Zeitstrahl</strong>
                <select class="gantt-zoom-select" id="ganttZoomSelect">
                    <option value="all">Gesamt</option>
                    <option value="30">30 Tage</option>
                    <option value="60">60 Tage</option>
                    <option value="90">90 Tage</option>
                </select>
            </div>
            <div class="timeline" id="ganttChart"></div>
        </div>
        <h3>üìÖ Agenda</h3>
        <div id="agendaList" class="task-list"></div>
    </div>

    <div id="tab-stats" class="tab-content">
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3 style="margin-top:0;">Fortschritt</h3>
                <div class="chart-container" id="mainPieChart">
                    <div class="chart-inner"><span class="chart-value" id="mainPercent">0%</span></div>
                </div>
            </div>
            <div class="stat-card" style="align-items: center; justify-content: flex-start;">
                <h3 style="margin-top:0; width:100%;">Leistung & Details</h3>
                <div id="uniStats" style="display:none; width:100%;">
                    <div class="gpa-box">‚àÖ Note (GPA) <span class="gpa-value" id="gpaValue">-</span></div>
                    <div style="margin-top:15px; width:100%;">
                        <div class="progress-header"><span>ECTS (benotet)</span> <span id="ectsCount">0 / 180</span></div>
                        <div class="progress-track"><div class="progress-fill" id="ectsBar" style="width:0%"></div></div>
                    </div>
                    <h4 style="margin-top:10px;">üéì Modul-Noten</h4>
                    <table class="module-table" id="moduleTable"></table>
                </div>
                <div class="progress-section" id="statsDetails" style="width:100%"></div>
            </div>
            <div class="stat-card" style="align-items: flex-start;">
                <h3 style="margin-top:0;">‚ö†Ô∏è Fokus-Bereiche</h3>
                <div class="stat-list" id="problemZonesList" style="width:100%"></div>
            </div>
        </div>
    </div>

    <div id="tab-backlog" class="tab-content">
        <div class="filter-row">
            <select id="filterPart" class="filter-select"><option value="all">Alle Bereiche</option></select>
            <select id="filterMod" class="filter-select"><option value="all">Alle Themen</option></select>
            <button class="btn-icon sm" style="background:var(--primary); width:auto; padding:0 15px;" id="btnAddTask">+ Neu</button>
        </div>
        <div id="backlogTree"></div>
        <div id="emptyBacklog" style="text-align:center; padding:40px; display:none;">
            <p style="color:var(--text-muted)">Katalog ist leer.</p>
            <button class="footer-link" style="background:var(--primary); color:white; border:none;" id="btnOpenImport">Daten importieren</button>
        </div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="phase-display" style="display:block;">
            <h3>üìñ Handbuch & Guide</h3>
            <div class="guide-box">
                <div class="guide-title">1. Der Start</div>
                <div class="guide-text">Lege zuerst oben rechts √ºber das <strong>+</strong> eine Pr√ºfung an und setze das Datum.</div>
            </div>
            <div class="guide-box">
                <div class="guide-title">2. Katalog & Import</div>
                <div class="guide-text">Nutze "Daten importieren", um IHK- oder Uni-Module zu laden. Dr√ºcke <strong>ENTER</strong> in einer Zeile, um schnell neue Aufgaben hinzuzuf√ºgen.</div>
            </div>
            <div class="guide-tip">üí° Tipp: Importierte Zeilen dienen oft als "Anker". Breche sie mit ENTER in kleine Aufgaben auf.</div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer-tools">
        <div class="footer-row">
            <a class="footer-link" id="btnToggleMode">üîÑ Modus: <span id="footerMode">IHK</span></a>
            <a class="footer-link" id="btnDownload">üíæ Backup</a>
            <a class="footer-link" id="btnRestore">üìÇ Laden</a>
        </div>
        <div class="footer-row">
            <a class="footer-link" style="color:var(--danger); border-color:var(--danger)" id="btnReset">‚ö†Ô∏è Reset</a>
        </div>
        <input type="file" id="fileInput" hidden>
    </div>

    <!-- MODALS -->
    <div id="importModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="margin-top:0">Katalog importieren</h3>
            <div id="ihkTemplates">
                <button class="template-btn" style="border-left:5px solid #0052cc" data-import="IHK:AP1">AP1 Komplett (Basis)</button>
                <button class="template-btn" style="border-left:5px solid #eab308" data-import="IHK:WISO">WiSo Komplett</button>
                <button class="template-btn" style="border-left:5px solid #a855f7" data-import="AP2Smart">AP2 Spezial (FISI / KIDG)</button>
            </div>
            <div id="uniTemplates" style="display:none;">
                <button class="template-btn" style="border-left:5px solid #10b981" data-import="UNI:INF_HWR">Informatik (HWR)</button>
                <button class="template-btn" style="border-left:5px solid #f59e0b" data-import="UNI:WI_HWR">W-Info (HWR)</button>
                <button class="template-btn" style="border-left:5px solid #3b82f6" data-import="UNI:WI_WILDAU">W-Info (Wildau)</button>
            </div>
            <label class="file-upload-label">
                üìÇ Eigene JSON Datei
                <input type="file" id="catalogImportInput" hidden accept=".json">
            </label>
            <button class="template-btn" style="text-align:center; margin-top:10px;" id="btnCloseImport">Abbrechen</button>
        </div>
    </div>

    <div id="toast">Info</div>

    <script>
        /* --- 1. DATA CATALOGS --- */
        const CATALOGS = {
            IHK: [
              {"part": "AP1", "mod": "Projektmanagement", "task": "Merkmale eines Projektes"}, {"part": "AP1", "mod": "Projektmanagement", "task": "Projektplanung"}, {"part": "AP1", "mod": "IT-Systeme", "task": "Hardware Komponenten"},
              {"part": "WISO", "mod": "Recht", "task": "Arbeitsvertrag"}, {"part": "WISO", "mod": "Sozial", "task": "Versicherungen"},
              {"part": "AP2", "mod": "Netzwerke", "task": "IPv4 Subnetting", "job": "FISI"}, {"part": "AP2", "mod": "Server", "task": "Virtualisierung", "job": "FISI"},
              {"part": "AP2", "mod": "Prozesse", "task": "BPMN", "job": "KIDG"}, {"part": "AP2", "mod": "Rechnungswesen", "task": "KLR", "job": "KIDG"}
            ],
            UNI: {
                "WI_HWR": [{"part": "Sem 1", "mod": "BWL", "task": "Grundlagen", "ects": 5}, {"part": "Sem 1", "mod": "IT", "task": "Java", "ects": 5}],
                "INF_HWR": [{"part": "Sem 1", "mod": "Mathe", "task": "Algebra", "ects": 7}, {"part": "Sem 1", "mod": "Prog", "task": "C", "ects": 5}],
                "WI_WILDAU": [{"part": "Sem 1", "mod": "BWL", "task": "Grundlagen", "ects": 5}]
            }
        };

        /* --- 2. HELPERS --- */
        const Utils = {
            escapeHtml(unsafe) {
                if (!unsafe) return "";
                return String(unsafe)
                      .replace(/&/g, "&amp;")
                      .replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;")
                      // Quotes are handled by attribute syntax usually, but for textContent safe
                      .replace(/"/g, "&quot;")
                      .replace(/'/g, "&#039;");
            },
            // FIX 1: Complete escapeAttr to handle all critical characters for attributes
            escapeAttr(unsafe) {
                if (!unsafe && unsafe !== 0) return "";
                return String(unsafe)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#39;");
            }
        };

        /* --- 3. DATA STORE --- */
        class Store {
            constructor() {
                this.exams = JSON.parse(localStorage.getItem('exams')) || [];
                this.tasks = JSON.parse(localStorage.getItem('wbsData')) || [];
                this.cockpit = JSON.parse(localStorage.getItem('cockpitTasks')) || [];
                this.moduleSettings = JSON.parse(localStorage.getItem('moduleSettings')) || {};
                this.activeExamId = localStorage.getItem('activeExamId');
                this.isUniMode = localStorage.getItem('isUniMode') === 'true';
                
                // Init default exam if empty
                if (this.exams.length === 0) {
                    const id = 'ex-' + Date.now();
                    this.exams.push({id, name: 'Standard Pr√ºfung', date: '', start: new Date().toISOString().split('T')[0]});
                    this.activeExamId = id;
                    this.save();
                } else if (!this.activeExamId || !this.exams.find(e => e.id === this.activeExamId)) {
                    this.activeExamId = this.exams[0].id;
                }
            }

            save() {
                localStorage.setItem('exams', JSON.stringify(this.exams));
                localStorage.setItem('wbsData', JSON.stringify(this.tasks));
                localStorage.setItem('cockpitTasks', JSON.stringify(this.cockpit));
                localStorage.setItem('moduleSettings', JSON.stringify(this.moduleSettings));
                localStorage.setItem('activeExamId', this.activeExamId);
                localStorage.setItem('isUniMode', this.isUniMode);
            }

            addTask(task) { this.tasks.push(task); this.save(); }
            
            updateTask(id, field, val) { 
                // Patch: Robust string comparison for IDs
                const t = this.tasks.find(x => String(x.id) === String(id)); 
                if(t) { 
                    t[field] = val; 
                    // Patch 3: Update lastTouched logic
                    t.lastTouched = new Date().toISOString();
                    this.save(); 
                } 
            }
            
            deleteTask(id) { 
                // Patch: Robust string comparison for IDs
                this.tasks = this.tasks.filter(t => String(t.id) !== String(id)); 
                this.cockpit = this.cockpit.filter(c => String(c.originId) !== String(id));
                this.save(); 
            }
            
            get activeExam() { return this.exams.find(e => e.id === this.activeExamId); }
            get currentTasks() { return this.tasks.filter(t => t.examId === this.activeExamId); }
        }

        const store = new Store();

        /* --- 4. UI COMPONENTS & RENDERING --- */
        const UI = {
            formatDate(str) { 
                if(!str) return ""; 
                const p = str.split('-'); 
                return p.length === 3 ? `${p[2]}.${p[1]}.${p[0]}` : str; 
            },
            
            parseDate(str) {
                if(!str) return "";
                const p = str.split('.');
                return p.length === 3 ? `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}` : str;
            },

            renderAll() {
                this.renderHeader();
                this.renderCockpit();
                this.renderBacklog();
                this.renderPlan();
                if(App && App.renderDashboard) App.renderDashboard();
            },

            renderHeader() {
                const sel = document.getElementById('examSelect');
                sel.innerHTML = '';
                store.exams.forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e.id;
                    opt.text = e.name;
                    if(e.id === store.activeExamId) opt.selected = true;
                    sel.appendChild(opt);
                });
                
                const ex = store.activeExam;
                const daysEl = document.getElementById('daysLeft');
                if (ex && ex.date) {
                    const diff = Math.ceil((new Date(ex.date) - new Date()) / 864e5);
                    daysEl.innerText = diff > 0 ? `Noch ${diff} Tage` : "Vorbei";
                } else {
                    daysEl.innerText = "Kein Datum";
                }
                
                document.getElementById('modeBadge').innerText = store.isUniMode ? "Student" : "Azubi";
                document.getElementById('footerMode').innerText = store.isUniMode ? "Uni" : "IHK";
                document.getElementById('ihkTemplates').style.display = store.isUniMode ? 'none' : 'block';
                document.getElementById('uniTemplates').style.display = store.isUniMode ? 'block' : 'none';
            },

            renderCockpit() {
                const list = document.getElementById('cockpitList');
                list.innerHTML = '';
                const myTasks = store.cockpit.filter(c => c.examId === store.activeExamId);
                document.getElementById('emptyCockpit').style.display = myTasks.length === 0 ? 'block' : 'none';

                myTasks.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'cockpit-card';
                    if (c.done) el.style.opacity = 0.5;
                    // Safe render using escapeHtml for display
                    el.innerHTML = `
                        <div>
                            <div style="font-size:0.75rem; color:var(--primary); font-weight:bold;">${Utils.escapeHtml(c.mod)}</div>
                            <div style="font-weight:600;">${Utils.escapeHtml(c.task)}</div>
                        </div>
                        <div class="check-btn ${c.done ? 'checked' : ''}" data-id="${c.id}">‚úì</div>
                    `;
                    list.appendChild(el);
                });
                
                const total = store.currentTasks.length;
                const done = store.currentTasks.filter(t => t.status === 'done').length;
                const p = total > 0 ? Math.round((done/total)*100) : 0;
                document.getElementById('progressText').innerText = p + '%';
            },

            renderBacklog() {
                const container = document.getElementById('backlogTree');
                container.innerHTML = '';
                let tasks = store.currentTasks;

                // FIX 2: Clean Rebuild of Select Options
                const sP = document.getElementById('filterPart');
                const sM = document.getElementById('filterMod');
                const oldP = sP.value; 
                const oldM = sM.value;

                // Reset and fill via DOM (prevents XSS in options)
                sP.innerHTML = ''; 
                sM.innerHTML = '';
                
                const defP = new Option('Alle Bereiche', 'all'); sP.add(defP);
                const defM = new Option('Alle Themen', 'all'); sM.add(defM);

                const parts = [...new Set(tasks.map(t => t.part))].sort();
                const mods = [...new Set(tasks.map(t => t.mod))].sort();
                
                parts.forEach(p => sP.add(new Option(p, p)));
                mods.forEach(m => sM.add(new Option(m, m)));
                
                if (parts.includes(oldP)) sP.value = oldP;
                if (mods.includes(oldM)) sM.value = oldM;

                if (sP.value !== 'all') tasks = tasks.filter(t => t.part === sP.value);
                if (sM.value !== 'all') tasks = tasks.filter(t => t.mod === sM.value);

                document.getElementById('emptyBacklog').style.display = tasks.length === 0 ? 'block' : 'none';

                const grouped = {};
                tasks.forEach(t => {
                    if (!grouped[t.part]) grouped[t.part] = {};
                    if (!grouped[t.part][t.mod]) grouped[t.part][t.mod] = [];
                    grouped[t.part][t.mod].push(t);
                });

                for (const [part, modules] of Object.entries(grouped)) {
                    const d1 = document.createElement('details');
                    d1.className = 'tree-level-1';
                    d1.open = true;
                    // FIX BUG 1: data-part NOT in HTML string, but set via DOM
                    d1.innerHTML = `<summary style="justify-content:space-between"><span>${Utils.escapeHtml(part)}</span><button class="action-btn del" data-action="delPart">√ó</button></summary>`;
                    d1.querySelector('button[data-action="delPart"]').dataset.part = part;

                    for (const [mod, tList] of Object.entries(modules)) {
                        const d2 = document.createElement('details');
                        d2.className = 'tree-level-2';
                        d2.open = true;
                        // FIX BUG 1: data-mod NOT in HTML string, but set via DOM
                        d2.innerHTML = `<summary style="justify-content:space-between"><span style="display:flex;gap:8px;align-items:center">üìÇ ${Utils.escapeHtml(mod)} <small>(${tList.length})</small></span><button class="action-btn del" data-action="delMod">√ó</button></summary>`;
                        const b2 = d2.querySelector('button[data-action="delMod"]');
                        b2.dataset.part = part;
                        b2.dataset.mod = mod;

                        tList.forEach(t => {
                            const r = document.createElement('div');
                            r.className = 'tree-item';
                            const pc = t.imp >= 8 ? 'red' : (t.imp >= 5 ? 'orange' : 'green');
                            
                            // FIX BUG 2: Value NOT in innerHTML. FIX BUG 1: data-part/mod NOT in innerHTML.
                            r.innerHTML = `
                                <div class="status-dot ${t.status}" data-action="cycleStatus" data-id="${t.id}"></div>
                                <div>
                                    <input id="input-${t.id}" class="item-input" data-action="updateTask" data-id="${t.id}" data-field="task">
                                    <div class="item-meta-row">
                                        <span class="prio-dot" style="background:${pc}"></span>
                                        <select class="mini-select" data-action="updateTask" data-id="${t.id}" data-field="imp">
                                            <option value="10" ${t.imp==10?'selected':''}>10</option>
                                            <option value="8" ${t.imp==8?'selected':''}>8</option>
                                            <option value="5" ${t.imp==5?'selected':''}>5</option>
                                            <option value="3" ${t.imp==3?'selected':''}>3</option>
                                        </select>
                                        <span style="opacity:0.3">|</span>
                                        <input type="number" class="mini-input" value="${t.time||30}" data-action="updateTask" data-id="${t.id}" data-field="time"> min
                                    </div>
                                </div>
                                <div style="display:flex; gap:5px;">
                                    <button class="action-btn" data-action="toCockpit" data-id="${t.id}">üöÄ</button>
                                    <button class="action-btn" data-action="moveTask" data-id="${t.id}">üìÇ</button>
                                    <button class="action-btn del" data-action="delTask" data-id="${t.id}">‚úï</button>
                                </div>
                            `;
                            // FIX BUG 1 & 2: Set raw values via DOM
                            const inp = r.querySelector('.item-input');
                            inp.dataset.part = part;
                            inp.dataset.mod = mod;
                            inp.value = t.task || "";
                            
                            d2.appendChild(r);
                        });
                        d1.appendChild(d2);
                    }
                    container.appendChild(d1);
                }
            },

            renderPlan(view = 'all') {
                const list = document.getElementById('agendaList');
                const chart = document.getElementById('ganttChart');
                list.innerHTML = ''; chart.innerHTML = '';
                
                const ve = store.exams.filter(e => e.date).sort((a,b) => new Date(a.date) - new Date(b.date));
                if (ve.length === 0) {
                    chart.innerHTML = '<div style="text-align:center;padding:20px;color:#999">Keine Daten</div>';
                    return;
                }

                ve.forEach(e => {
                    const bs = e.id === store.activeExamId ? 'border-left:4px solid var(--primary)' : 'border-left:4px solid #999';
                    const diff = Math.ceil((new Date(e.date) - new Date()) / 864e5);
                    list.innerHTML += `<div class="agenda-item" style="${bs}"><span><strong>${Utils.escapeHtml(e.name)}</strong><br><small>${UI.formatDate(e.start||'')} -> ${UI.formatDate(e.date)}</small></span><span>${diff} T</span></div>`;
                });

                const today = new Date();
                let vs, ve_d;
                if (view === 'all') {
                    let min = new Date(ve[0].start || today).getTime();
                    let max = new Date(ve[ve.length-1].date).getTime();
                    vs = new Date(min); vs.setDate(vs.getDate() - 7);
                    ve_d = new Date(max); ve_d.setDate(ve_d.getDate() + 7);
                } else {
                    vs = new Date(today); vs.setDate(vs.getDate() - 3);
                    ve_d = new Date(today); ve_d.setDate(ve_d.getDate() + parseInt(view));
                }
                const tot = ve_d - vs;
                
                if (today >= vs && today <= ve_d) {
                    chart.innerHTML += `<div class="today-line" style="left:${((today - vs) / tot) * 100}%"></div>`;
                }

                ve.forEach(e => {
                    const s = new Date(e.start || today);
                    const d = new Date(e.date);
                    if (d < vs || s > ve_d) return;
                    const L = Math.max(0, ((s - vs) / tot) * 100);
                    const W = Math.min(100, ((d - vs) / tot) * 100) - L;
                    const col = e.id === store.activeExamId ? 'var(--primary)' : '#94a3b8';
                    const op = e.id === store.activeExamId ? '1' : '0.5';
                    chart.innerHTML += `<div class="bar-row"><div class="bar" style="left:${L}%;width:${W}%;background:${col};opacity:${op}">${Utils.escapeHtml(e.name)}</div></div>`;
                });
            }
        };

        /* --- 5. APP CONTROLLER --- */
        const App = {
            init() {
                if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
                
                App.applyDecay(); 
                
                document.getElementById('btnToggleDark').addEventListener('click', App.toggleDark);
                document.getElementById('examSelect').addEventListener('change', App.switchExam);
                document.getElementById('btnAddExam').addEventListener('click', App.addExam);
                document.getElementById('btnEditExam').addEventListener('click', App.editExam);
                
                document.getElementById('mainTabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn')) App.switchTab(e.target.dataset.tab);
                });
                
                document.getElementById('btnAutoFill').addEventListener('click', App.autoFill);
                document.getElementById('ganttZoomSelect').addEventListener('change', (e) => UI.renderPlan(e.target.value));
                
                document.getElementById('filterPart').addEventListener('change', UI.renderBacklog);
                document.getElementById('filterMod').addEventListener('change', UI.renderBacklog);
                document.getElementById('btnAddTask').addEventListener('click', App.addTask);
                
                document.getElementById('btnOpenImport').addEventListener('click', () => document.getElementById('importModal').style.display='flex');
                document.getElementById('btnCloseImport').addEventListener('click', () => document.getElementById('importModal').style.display='none');
                
                document.getElementById('btnToggleMode').addEventListener('click', App.toggleMode);
                document.getElementById('btnDownload').addEventListener('click', App.backup);
                document.getElementById('btnRestore').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('btnReset').addEventListener('click', App.reset);
                
                document.getElementById('fileInput').addEventListener('change', App.loadFile);
                document.getElementById('catalogImportInput').addEventListener('change', App.importFile);
                
                document.getElementById('tab-stats').addEventListener('change', (e) => {
                    if(e.target.dataset.action === 'updMod') {
                        App.updMod(e.target.dataset.mod, e.target.dataset.field, e.target.value);
                    }
                });
                
                document.querySelectorAll('.template-btn[data-import]').forEach(btn => {
                    btn.addEventListener('click', (e) => App.runTemplateImport(e.target.dataset.import));
                });
                
                document.getElementById('cockpitList').addEventListener('click', (e) => {
                    if(e.target.classList.contains('check-btn')) App.toggleDone(e.target.dataset.id);
                });

                document.getElementById('backlogTree').addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    const id = e.target.dataset.id;
                    
                    // Patch 4: Safe click handler for summary buttons
                    if (action === 'delPart') { e.preventDefault(); e.stopPropagation(); App.deletePart(e.target.dataset.part); return; }
                    if (action === 'delMod') { e.preventDefault(); e.stopPropagation(); App.deleteMod(e.target.dataset.part, e.target.dataset.mod); return; }

                    if (!action || !id) return;
                    
                    if (action === 'cycleStatus') App.cycleStatus(id);
                    if (action === 'toCockpit') App.toCockpit(id);
                    if (action === 'delTask') App.deleteTask(id);
                    if (action === 'moveTask') App.moveTask(id);
                });
                
                document.getElementById('backlogTree').addEventListener('change', (e) => {
                    if(e.target.dataset.action === 'updateTask') {
                        store.updateTask(e.target.dataset.id, e.target.dataset.field, e.target.value);
                        if(e.target.dataset.field === 'imp') UI.renderBacklog();
                    }
                });
                
                document.getElementById('backlogTree').addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && e.target.classList.contains('item-input')) {
                        e.preventDefault();
                        App.quickAdd(e.target.dataset.part, e.target.dataset.mod);
                    }
                });

                UI.renderAll();
            },

            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
                document.getElementById('tab-'+tabId).classList.add('active');
                document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
                if(tabId === 'plan') UI.renderPlan();
                if(tabId === 'stats') App.renderDashboard();
            },
            
            toggleDark() {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            },
            
            toggleMode() {
                store.isUniMode = !store.isUniMode;
                store.save();
                UI.renderAll();
            },

            switchExam() { store.activeExamId = document.getElementById('examSelect').value; store.save(); UI.renderAll(); },
            
            addExam() {
                const n = prompt("Name:"); if(!n) return;
                const d = UI.parseDate(prompt("Datum (TT.MM.JJJJ):"));
                const s = UI.parseDate(prompt("Start (TT.MM.JJJJ):"));
                const id = 'ex-'+Date.now();
                store.exams.push({id, name:n, date:d, start:s});
                store.activeExamId = id;
                store.save(); UI.renderAll();
            },

            editExam() {
                const ex = store.activeExam;
                const n = prompt("Name", ex.name); if(n) ex.name = n;
                const d = prompt("Datum", UI.formatDate(ex.date)); if(d) ex.date = UI.parseDate(d);
                const s = prompt("Start", UI.formatDate(ex.start)); if(s) ex.start = UI.parseDate(s);
                store.save(); UI.renderAll();
            },

            addTask() {
                const p = prompt("Bereich", document.getElementById('filterPart').value !== 'all' ? document.getElementById('filterPart').value : (store.isUniMode ? "Semester 1" : "Allgemein"));
                if(!p) return;
                const m = prompt("Thema", "Unsortiert");
                if(!m) return;
                store.addTask({id:'t-'+Date.now(), examId:store.activeExamId, part:p, mod:m, task:"Neue Aufgabe", status:'todo', imp:5, time:30, level:0, decayFlag:false, lastTouched:new Date().toISOString()});
                UI.renderBacklog();
            },

            quickAdd(part, mod) {
                const id = 't-'+Date.now();
                store.addTask({id, examId:store.activeExamId, part, mod, task:"", status:'todo', imp:5, time:30, level:0, decayFlag:false, lastTouched:new Date().toISOString()});
                UI.renderBacklog();
                setTimeout(() => document.getElementById('input-'+id)?.focus(), 50);
            },

            deleteTask(id) {
                if(confirm("L√∂schen?")) { store.deleteTask(id); UI.renderBacklog(); UI.renderCockpit(); }
            },

            // Patch 1: Filter on Current Exam only
            deletePart(part) {
                if(confirm(`Bereich ${part} l√∂schen?`)) {
                    const ids = store.currentTasks.filter(t => t.part === part).map(t => t.id);
                    ids.forEach(id => store.deleteTask(id));
                    UI.renderBacklog();
                }
            },
            
            deleteMod(part, mod) {
                if(confirm(`Ordner ${mod} l√∂schen?`)) {
                    const ids = store.currentTasks.filter(t => t.part === part && t.mod === mod).map(t => t.id);
                    ids.forEach(id => store.deleteTask(id));
                    UI.renderBacklog();
                }
            },

            moveTask(id) {
                const t = store.tasks.find(x => String(x.id) === String(id));
                const p = prompt("Bereich", t.part); if(p) t.part = p;
                const m = prompt("Thema", t.mod); if(m) t.mod = m;
                store.save(); UI.renderBacklog();
            },

            toCockpit(id) {
                // Patch: Robust string comparison for IDs
                if(store.cockpit.some(c => String(c.originId) === String(id))) return App.toast("Schon geplant");
                const t = store.tasks.find(x => String(x.id) === String(id));
                store.cockpit.push({id:'cp-'+Date.now(), originId:id, examId:store.activeExamId, mod:t.mod, task:t.task, done:false});
                // Patch 3: Last Touched Logic
                t.status = 'doing';
                t.lastTouched = new Date().toISOString();
                store.save(); UI.renderAll();
            },

            toggleDone(cpId) {
                // Patch: Robust string comparison for IDs
                const c = store.cockpit.find(x => String(x.id) === String(cpId));
                if(!c) return;
                c.done = !c.done;
                const t = store.tasks.find(x => String(x.id) === String(c.originId));
                if(t) {
                    if(c.done) { 
                        t.status='done'; 
                        t.lastReviewed=new Date().toISOString().split('T')[0]; 
                        t.level=(t.level||0)+1; 
                        t.decayFlag=false;
                    } else { 
                        t.status='doing';
                        t.lastTouched = new Date().toISOString();
                    }
                }
                store.save(); UI.renderAll();
                if(c.done) setTimeout(() => { 
                    store.cockpit = store.cockpit.filter(x => String(x.id) !== String(cpId)); 
                    store.save(); 
                    UI.renderCockpit(); 
                }, 800);
            },

            cycleStatus(id) {
                // Patch: Robust string comparison for IDs
                const t = store.tasks.find(x => String(x.id) === String(id));
                if(t.status === 'todo') { t.status='doing'; t.lastTouched = new Date().toISOString(); }
                else if(t.status === 'doing') { t.status='done'; t.lastReviewed=new Date().toISOString().split('T')[0]; t.level=(t.level||0)+1; t.decayFlag=false; }
                else t.status='todo';
                store.save(); UI.renderBacklog();
            },

            autoFill() {
                // Patch: Robust string comparison for IDs
                const p = store.currentTasks.filter(t => t.status !== 'done' && !store.cockpit.some(c => String(c.originId) === String(t.id)));
                if(p.length === 0) return App.toast("Nichts gefunden");
                p.slice(0,3).forEach(t => {
                    store.cockpit.push({id:'cp-'+Math.random(), originId:t.id, examId:store.activeExamId, mod:t.mod, task:t.task, done:false});
                    t.status='doing';
                    t.lastTouched = new Date().toISOString();
                });
                store.save(); UI.renderAll(); App.toast("Gef√ºllt");
            },

            runTemplateImport(type) {
                if(!confirm("Importieren?")) return;
                let data = [];
                
                if(type.startsWith('IHK:')) {
                    const part = type.split(':')[1];
                    data = CATALOGS.IHK.filter(i => i.part === part);
                } else if (type === 'AP2Smart') {
                    const job = prompt("Beruf? 1=FISI, 2=FIAE, 3=KAUF");
                    if(!job) return;
                    const target = (job==="1")?"FISI":(job==="2")?"FIAE":"KIDG";
                    data = CATALOGS.IHK.filter(i => i.part === "AP2" && (!i.job || i.job === target));
                } else if (type.startsWith('UNI:')) {
                    data = CATALOGS.UNI[type.split(':')[1]];
                }

                if(data) App.importEngine(data, type.includes('UNI') ? 60 : 30);
            },

            importEngine(items, time) {
                let count = 0;
                items.forEach(i => {
                    // Patch 2: Deduplication using normalized values
                    const p = i.part || "Import";
                    const m = i.mod || "Sonstiges";
                    const t = i.task;
                    
                    if(!store.currentTasks.some(exist => exist.part === p && exist.mod === m && exist.task === t)) {
                        // Patch: Ensure string ID generation
                        store.addTask({id: 't-' + Date.now() + '-' + Math.random().toString(16).slice(2), examId:store.activeExamId, part:p, mod:m, task:t, status:'todo', imp:5, time, level:0, decayFlag:false, lastTouched: new Date().toISOString()});
                        if(store.isUniMode && i.ects && !store.moduleSettings[m]) {
                            store.moduleSettings[m] = {ects: i.ects, grade:''};
                        }
                        count++;
                    }
                });
                store.save(); UI.renderAll(); 
                document.getElementById('importModal').style.display='none';
                App.toast(`${count} Importiert`);
            },
            
            importFile(e) {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if(Array.isArray(d)) App.importEngine(d, 30);
                    } catch(x) { alert("Fehler"); }
                };
                r.readAsText(f);
            },

            backup() {
                // Versioned backup
                const blob = new Blob([JSON.stringify({schemaVersion: 1, exams:store.exams, tasks:store.tasks, cockpit:store.cockpit, settings:store.moduleSettings, meta:{active:store.activeExamId, uni:store.isUniMode}})], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
            },
            
            loadFile(e) {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        store.exams=d.exams; store.tasks=d.tasks; store.cockpit=d.cockpit; store.moduleSettings=d.settings||{}; store.activeExamId=d.meta.active; store.isUniMode=d.meta.uni;
                        store.save(); location.reload();
                    } catch(x) { alert("Datei defekt"); }
                };
                r.readAsText(f);
            },

            reset() { if(confirm("Alles l√∂schen?")) { localStorage.clear(); location.reload(); } },
            toast(m) { const t = document.getElementById('toast'); t.innerText=m; t.className='show'; setTimeout(()=>t.className='', 2000); },

            applyDecay() {
                let changed = false;
                store.tasks.forEach(t => {
                    // Decay Done -> Doing
                    if(t.status === 'done' && t.lastReviewed) {
                        const diff = Math.floor((new Date() - new Date(t.lastReviewed)) / 864e5);
                        
                        // NEW TIERED LOGIC (3, 7, 14, 30 days)
                        let limit = 3;
                        const lvl = t.level || 0;
                        if (lvl >= 4) limit = 30;
                        else if (lvl === 3) limit = 14;
                        else if (lvl === 2) limit = 7;
                        
                        if(diff > limit) { t.status = 'doing'; t.decayFlag = true; changed = true; }
                    } 
                    // Decay Doing -> Todo (Patch 3 logic applied)
                    else if (t.status === 'doing' && t.lastTouched) {
                         const diff = Math.floor((new Date() - new Date(t.lastTouched)) / 864e5);
                         if (diff > 7) { t.status = 'todo'; t.decayFlag = true; changed = true; }
                    }
                });
                if(changed) { store.save(); }
            },

            renderDashboard() {
                const ds = store.currentTasks;
                const tot = ds.length;
                
                document.getElementById('uniStats').style.display = store.isUniMode ? 'block' : 'none';
                document.getElementById('statsDetails').style.display = store.isUniMode ? 'none' : 'block';

                if(tot === 0) { document.getElementById('mainPercent').innerText="0%"; return; }
                
                const done = ds.filter(t => t.status === 'done').length;
                const perc = Math.round((done/tot)*100);
                document.getElementById('mainPieChart').style.background = `conic-gradient(var(--chart-done) 0deg ${Math.round(perc*3.6)}deg, var(--border) 0deg 360deg)`;
                document.getElementById('mainPercent').innerText = perc + "%";

                if (store.isUniMode) {
                    const mods=[...new Set(ds.map(t=>t.mod))].sort(); let h=''; let sumG=0, sumE=0, totE=0;
                    mods.forEach((m, index)=>{
                        const s=store.moduleSettings[m]||{ects:5,grade:''}; const e=parseFloat(s.ects)||0; const g=parseFloat(s.grade);
                        // FIX BUG 3: data-mod NOT in HTML string. Use index to link back.
                        h+=`<tr><td>${Utils.escapeHtml(m)}</td><td><input type="number" value="${s.ects}" data-action="updMod" data-idx="${index}" data-field="ects"></td><td><input type="number" step="0.1" value="${s.grade}" placeholder="-" data-action="updMod" data-idx="${index}" data-field="grade"></td></tr>`;
                        totE+=e; if(g>0){sumG+=g*e; sumE+=e;}
                    });
                    const table = document.getElementById('moduleTable');
                    table.innerHTML=h;
                    // FIX BUG 3: Set raw data-mod via DOM
                    table.querySelectorAll('input[data-action="updMod"]').forEach(inp => {
                        const i = inp.getAttribute('data-idx');
                        if(mods[i]) inp.dataset.mod = mods[i];
                    });

                    document.getElementById('gpaValue').innerText=sumE>0?(sumG/sumE).toFixed(1):"-";
                    document.getElementById('ectsBar').style.width=(totE>0?(sumE/totE)*100:0)+"%";
                    document.getElementById('ectsCount').innerText=`${sumE} / ${totE}`; // Label updated
                } else {
                    // AZUBI / IHK DASHBOARD LOGIC (NEW)
                    const partsMap = {};
                    let countDoing = 0;

                    ds.forEach(t => {
                        if (t.status === 'doing') countDoing++;
                        const p = t.part || 'Sonstiges';
                        if (!partsMap[p]) partsMap[p] = { name: p, total: 0, done: 0 };
                        partsMap[p].total++;
                        if (t.status === 'done') partsMap[p].done++;
                    });

                    // Sort: Lowest % first (focus needed), then most open tasks
                    const sortedParts = Object.values(partsMap).map(p => {
                        p.pct = p.total > 0 ? Math.round((p.done / p.total) * 100) : 0;
                        p.open = p.total - p.done;
                        return p;
                    }).sort((a, b) => {
                        if (a.pct !== b.pct) return a.pct - b.pct;
                        return b.open - a.open;
                    });

                    const totalOpen = tot - done;
                    let h = `
                    <div style="display:flex; gap:8px; margin-bottom:20px; justify-content:space-between; text-align:center;">
                        <div style="background:var(--hover-bg); padding:8px; border-radius:8px; flex:1;">
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Erledigt</div>
                            <div style="font-weight:800; font-size:1.1rem; color:var(--success)">${done} <span style="font-size:0.8rem; color:var(--text-muted); font-weight:normal">/ ${tot}</span></div>
                        </div>
                        <div style="background:var(--hover-bg); padding:8px; border-radius:8px; flex:1;">
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Offen</div>
                            <div style="font-weight:800; font-size:1.1rem; color:var(--danger)">${totalOpen}</div>
                        </div>
                        <div style="background:var(--hover-bg); padding:8px; border-radius:8px; flex:1;">
                            <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Doing</div>
                            <div style="font-weight:800; font-size:1.1rem; color:var(--warning-text)">${countDoing}</div>
                        </div>
                    </div>
                    <h4 style="margin-top:0; margin-bottom:12px; color:var(--text-muted); font-size:0.85rem; text-transform:uppercase; letter-spacing:1px;">Bereiche (Priorit√§t)</h4>
                    `;

                    sortedParts.forEach(p => {
                        const barColor = p.pct === 100 ? 'var(--success)' : (p.pct < 50 ? '#ef4444' : 'var(--primary)');
                        h += `
                        <div class="progress-row">
                            <div class="progress-header" style="align-items:center;">
                                <span>${Utils.escapeHtml(p.name)}</span>
                                <span style="font-size:0.8rem; font-weight:bold; color:var(--text-muted)">${p.done}/${p.total} (${p.pct}%)</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width:${p.pct}%; background:${barColor}"></div>
                            </div>
                        </div>`;
                    });

                    if (sortedParts.length === 0) h += '<div style="color:var(--text-muted); text-align:center; padding:10px;">Keine Aufgaben im Katalog.</div>';
                    
                    document.getElementById('statsDetails').innerHTML = h;
                }
                const map={}; ds.forEach(t=>{if(t.status!=='done'){const m=t.mod||'Sonstiges'; map[m]=(map[m]||0)+1;}});
                const sort=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3);
                let ph=''; sort.forEach(([m,c])=>ph+=`<div class="stat-list-item"><span>${Utils.escapeHtml(m)}</span><span style="font-weight:bold;color:var(--danger)">${c} offen</span></div>`);
                document.getElementById('problemZonesList').innerHTML=ph||"<div style='text-align:center;color:var(--success)'>Alles sauber!</div>";
            },

            updMod(m, f, v) {
                if(!store.moduleSettings[m]) store.moduleSettings[m]={ects:5, grade:''};
                store.moduleSettings[m][f] = v;
                store.save();
                App.renderDashboard();
            }
        };

        window.onload = App.init;
    </script>
</body>
</html>
