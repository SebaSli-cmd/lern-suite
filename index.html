<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Lern-Suite V31.9 (Clean Code)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0052cc">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/brain--v1.png">

    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #0052cc; --primary-dark: #003d99; --bg: #f8fafc; --card-bg: #ffffff;
            --text: #0f172a; --text-muted: #475569; --border: #cbd5e1; --input-bg: #ffffff;
            --header-cell-bg: #f1f5f9; --hover-bg: #e2e8f0; --success: #15803d; --danger: #b91c1c;
            --warning-bg: #fff7ed; --warning-text: #9a3412; --prio-high: #dc2626; --prio-mid: #d97706; --prio-low: #16a34a;
            --chart-done: #22c55e; --grade-bg: #ecfccb; --grade-text: #365314;
        }
        body.dark-mode {
            --primary: #60a5fa; --primary-dark: #3b82f6; --bg: #0f172a; --card-bg: #1e293b;
            --text: #f8fafc; --text-muted: #cbd5e1; --border: #475569; --input-bg: #020617;
            --header-cell-bg: #1e293b; --hover-bg: #334155; --warning-bg: #451a03; --warning-text: #fb923c;
            --grade-bg: #3f6212; --grade-text: #ecfccb;
        }

        /* --- BASE --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 140px; line-height: 1.5; -webkit-tap-highlight-color: transparent; }
        input, select, textarea { font-size: 16px !important; outline: none; }
        
        /* --- COMPONENTS --- */
        .suite-header { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 15px; }
        .header-top { display: flex; flex-direction: column; gap: 10px; }
        @media (min-width: 600px) { .header-top { flex-direction: row; justify-content: space-between; align-items: center; } }
        .header-info h1 { margin: 0; font-size: 1.4rem; }
        .header-controls-wrapper { display: flex; gap: 8px; align-items: center; }
        
        .btn-icon { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-icon.sm { width: 32px; font-size: 0.9rem; } /* Cleaned up inline styles */
        #examSelect { flex-grow: 1; padding: 0 10px; border-radius: 6px; border: none; font-weight: bold; color: #333; height: 36px; }

        .tabs { display: flex; gap: 5px; overflow-x: auto; margin-top: 15px; padding-bottom: 2px; }
        .tab-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; white-space: nowrap; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* --- VIEWS --- */
        .phase-display { background: var(--card-bg); padding: 15px; border-radius: 12px; border-left: 5px solid var(--primary); margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .btn-magic { background: linear-gradient(135deg, #7c3aed, #db2777); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; margin-bottom: 15px; cursor: pointer; }
        
        .task-list { display: flex; flex-direction: column; gap: 8px; }
        .cockpit-card { background: var(--card-bg); padding: 12px; border-radius: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: opacity 0.3s ease; }
        .check-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border); background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: transparent; font-size: 1.2rem; transition: all 0.2s; }
        .check-btn.checked { background: var(--success); border-color: var(--success); color: white; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.02); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .chart-container { position: relative; width: 160px; height: 160px; border-radius: 50%; background: conic-gradient(var(--chart-done) 0deg, var(--border) 0deg 360deg); display: flex; align-items: center; justify-content: center; margin-bottom: 15px; transition: background 0.5s ease; }
        .chart-inner { width: 120px; height: 120px; background: var(--card-bg); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .chart-value { font-size: 1.8rem; font-weight: 800; color: var(--text); }
        
        .gpa-box { background: var(--grade-bg); color: var(--grade-text); padding: 15px; border-radius: 12px; width: 100%; margin-top: 10px; text-align: center; font-weight: bold; border: 1px solid var(--border); }
        .module-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .module-table th { text-align: left; color: var(--text-muted); padding: 5px; border-bottom: 1px solid var(--border); }
        .module-table td { padding: 8px 5px; border-bottom: 1px solid var(--border); }
        .module-table input { width: 50px; padding: 5px; border-radius: 4px; border: 1px solid var(--border); text-align: center; background: rgba(255,255,255,0.5); }
        .progress-row { margin-bottom: 12px; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        .progress-track { width: 100%; height: 10px; background: var(--hover-bg); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.8s ease; }
        .stat-list-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.95rem; }

        .filter-row { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; background: var(--header-cell-bg); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .filter-select { flex-grow: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-weight: bold; }
        #wbsTreeContainer { display: flex; flex-direction: column; gap: 10px; }
        details.tree-level-1 { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        details.tree-level-1 > summary { padding: 12px; background: var(--header-cell-bg); font-weight: bold; cursor: pointer; list-style: none; display: flex; justify-content: space-between; }
        details.tree-level-1 > summary::-webkit-details-marker { display: none; }
        details.tree-level-2 { border-top: 1px solid var(--border); }
        details.tree-level-2 > summary { padding: 10px 12px; font-weight: 600; cursor: pointer; color: var(--primary); background: var(--card-bg); display: flex; align-items: center; gap: 8px; }
        
        .tree-item { display: grid; grid-template-columns: 25px 1fr auto; gap: 10px; align-items: center; background: var(--card-bg); padding: 8px 12px; border-top: 1px solid var(--border); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; cursor: pointer; margin: 0 auto; }
        .status-dot.todo { background: var(--danger); }
        .status-dot.doing { background: var(--warning-text); }
        .status-dot.done { background: var(--success); }
        .item-input { width: 100%; border: none; background: transparent; font-weight: 500; color: var(--text); padding: 2px 0; }
        .item-meta-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); }
        .mini-select { border: none; background: transparent; font-size: inherit; color: inherit; font-weight: 600; cursor: pointer; padding: 0; }
        .mini-input { border: none; background: transparent; font-size: inherit; color: inherit; width: 30px; text-align: center; border-bottom: 1px dashed var(--border); }
        .prio-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:2px; flex-shrink:0; }
        .action-btn { width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 6px; background: white; color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .action-btn:hover { border-color: var(--primary); color: var(--primary); }
        .action-btn.del:hover { border-color: var(--danger); color: var(--danger); background: #fee2e2; }

        .gantt-box { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; padding: 10px; margin-bottom: 20px; }
        .gantt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .gantt-zoom-select { padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 0.8rem; }
        .timeline { position: relative; min-height: 50px; padding: 10px 0; }
        .bar-row { height: 25px; margin-bottom: 5px; position: relative; }
        .bar { position: absolute; height: 20px; background: var(--primary); border-radius: 4px; color: white; font-size: 0.7rem; display: flex; align-items: center; padding-left: 5px; opacity: 0.8; white-space: nowrap; overflow: hidden;}
        .today-line { position: absolute; top:0; bottom:0; width: 2px; background: var(--danger); z-index: 10; }
        .agenda-item { background: var(--card-bg); padding: 10px; border-radius: 8px; border-left: 4px solid var(--text-muted); margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; }

        .footer-tools { margin-top: 40px; text-align: center; display: flex; flex-direction: column; gap: 10px; opacity: 0.9; }
        .footer-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .footer-link { border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px; color: var(--text); text-decoration: none; font-size: 0.85rem; background: var(--card-bg); cursor: pointer; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-card { background: var(--card-bg); width: 100%; max-width: 400px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .template-btn { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 8px; text-align: left; background: var(--bg); cursor: pointer; color: var(--text); font-weight: bold; }
        .file-upload-label { display: block; width: 100%; padding: 15px; border: 2px dashed var(--primary); border-radius: 8px; text-align: center; color: var(--primary); cursor: pointer; margin-bottom: 10px; font-weight: bold; background: var(--hover-bg); }
        .file-upload-label:hover { background: #e0f2fe; }
        
        .guide-box { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .guide-box:last-child { border-bottom: none; }
        .guide-title { font-size: 1rem; font-weight: bold; margin-bottom: 8px; color: var(--primary); }
        .guide-text { font-size: 0.9rem; line-height: 1.5; color: var(--text); }
        .guide-tip { background: var(--input-bg); padding: 10px; border-left: 3px solid var(--warning-text); border-radius: 4px; margin-top: 10px; font-size: 0.85rem; font-style: italic; }

        #toast { visibility: hidden; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; z-index: 3000; font-size: 0.9rem; }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
    </style>
</head>
<body>

    <div class="suite-header">
        <div class="header-top">
            <div class="header-info">
                <h1>üéì Lern-Suite V31.9</h1>
                <p id="modeBadge">Azubi Edition</p>
            </div>
            <div class="header-controls-wrapper">
                <button class="btn-icon" onclick="toggleDark()">üåô</button>
                <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:8px; display:flex; gap:4px; flex-grow:1;">
                    <select id="examSelect" onchange="switchExam()"></select>
                    <button class="btn-icon sm" onclick="editExam()" title="Datum √§ndern">‚úèÔ∏è</button>
                    <button class="btn-icon sm" onclick="addExam()" title="Neu">+</button>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('cockpit')" id="btn-cockpit">üöÄ Cockpit</button>
            <button class="tab-btn" onclick="showTab('plan')" id="btn-plan">üìÖ Zeitplan</button>
            <button class="tab-btn" onclick="showTab('stats')" id="btn-stats">üìä Stats</button>
            <button class="tab-btn" onclick="showTab('backlog')" id="btn-backlog">üìö Katalog</button>
            <button class="tab-btn" onclick="showTab('info')" id="btn-info">‚ÑπÔ∏è Info</button>
        </div>
    </div>

    <!-- 1. COCKPIT -->
    <div id="tab-cockpit" class="tab-content active">
        <div class="phase-display">
            <div><strong>Aktuelle Phase</strong><div style="font-size:0.8rem; opacity:0.7" id="daysLeft">...</div></div>
            <div id="progressText" style="font-weight:bold; color:var(--primary)">0%</div>
        </div>
        <button class="btn-magic" onclick="autoFill()">ü™Ñ Smart Auto-Fill (Lernplan f√ºllen)</button>
        <div id="cockpitList" class="task-list"></div>
        <div id="emptyCockpit" style="text-align:center; padding:30px; display:none; color:var(--text-muted)">Nichts zu tun. Hol dir Aufgaben aus dem Katalog.</div>
    </div>

    <!-- 2. ZEITPLAN -->
    <div id="tab-plan" class="tab-content">
        <div class="gantt-box">
            <div class="gantt-header">
                <strong>Zeitstrahl</strong>
                <select class="gantt-zoom-select" id="ganttZoomSelect" onchange="updateGanttView()">
                    <option value="all">Gesamt</option>
                    <option value="30">30 Tage</option>
                    <option value="60">60 Tage</option>
                    <option value="90">90 Tage</option>
                </select>
            </div>
            <div class="timeline" id="ganttChart"></div>
        </div>
        <h3>üìÖ Agenda</h3>
        <div id="agendaList" class="task-list"></div>
    </div>

    <!-- 3. STATS -->
    <div id="tab-stats" class="tab-content">
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3 style="margin-top:0;">Fortschritt</h3>
                <div class="chart-container" id="mainPieChart">
                    <div class="chart-inner"><span class="chart-value" id="mainPercent">0%</span></div>
                </div>
            </div>
            <div class="stat-card" style="align-items: center; justify-content: flex-start;">
                <h3 style="margin-top:0; width:100%;">Leistung & Details</h3>
                <div id="uniStats" style="display:none; width:100%;">
                    <div class="gpa-box">‚àÖ Note (GPA) <span class="gpa-value" id="gpaValue">-</span></div>
                    <div style="margin-top:15px; width:100%;">
                        <div class="progress-header"><span>ECTS Fortschritt</span> <span id="ectsCount">0 / 180</span></div>
                        <div class="progress-track"><div class="progress-fill" id="ectsBar" style="width:0%"></div></div>
                    </div>
                    <h4 style="margin-top:10px;">üéì Modul-Noten</h4>
                    <table class="module-table" id="moduleTable"></table>
                </div>
                <div class="progress-section" id="statsDetails"></div>
            </div>
            <div class="stat-card" style="align-items: flex-start;">
                <h3 style="margin-top:0;">‚ö†Ô∏è Fokus-Bereiche</h3>
                <div class="stat-list" id="problemZonesList" style="width:100%"></div>
            </div>
        </div>
    </div>

    <!-- 4. BACKLOG -->
    <div id="tab-backlog" class="tab-content">
        <div class="filter-row">
            <select id="filterPart" class="filter-select" onchange="renderBacklog()"><option value="all">Alle Bereiche</option></select>
            <select id="filterMod" class="filter-select" onchange="renderBacklog()"><option value="all">Alle Themen</option></select>
            <button class="btn-icon sm" style="background:var(--primary); width:auto; padding:0 15px;" onclick="addTask()">+ Neu</button>
        </div>
        <div id="backlogTree"></div>
        <div id="emptyBacklog" style="text-align:center; padding:40px; display:none;">
            <p style="color:var(--text-muted)">Katalog ist leer.</p>
            <button class="footer-link" style="background:var(--primary); color:white; border:none;" onclick="openImport()">Daten importieren</button>
        </div>
    </div>

    <!-- 5. INFO -->
    <div id="tab-info" class="tab-content">
        <div class="phase-display" style="display:block;">
            <h3>üìñ Handbuch & Guide</h3>
            <div class="guide-box">
                <div class="guide-title">1. Der Start</div>
                <div class="guide-text">Lege zuerst oben rechts √ºber das <strong>+</strong> eine Pr√ºfung an und setze das Datum.</div>
            </div>
            <div class="guide-box">
                <div class="guide-title">2. Katalog & Import</div>
                <div class="guide-text">Nutze "Daten importieren", um IHK- oder Uni-Module zu laden. Dr√ºcke <strong>ENTER</strong> in einer Zeile, um schnell neue Aufgaben hinzuzuf√ºgen.</div>
            </div>
            <div class="guide-tip">üí° Tipp: Importierte Zeilen dienen oft als "Anker". Breche sie mit ENTER in kleine Aufgaben auf.</div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer-tools">
        <div class="footer-row">
            <a class="footer-link" onclick="toggleUniMode()">üîÑ Modus: <span id="footerMode">IHK</span></a>
            <a class="footer-link" onclick="downloadBackup()">üíæ Backup</a>
            <a class="footer-link" onclick="restoreBackup()">üìÇ Laden</a>
        </div>
        <div class="footer-row">
            <a class="footer-link" style="color:var(--danger); border-color:var(--danger)" onclick="hardReset()">‚ö†Ô∏è Reset</a>
        </div>
        <input type="file" id="fileInput" hidden onchange="loadFile(event)">
    </div>

    <!-- IMPORT MODAL -->
    <div id="importModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="margin-top:0">Katalog importieren</h3>
            <p style="font-size:0.9rem; color:var(--text-muted);">Daten werden hinzugef√ºgt (nicht √ºberschrieben).</p>
            
            <div id="ihkTemplates">
                <button class="template-btn" style="border-left:5px solid #0052cc" onclick="loadIHKData('AP1')">üü¶ AP1 Komplett (Basis)</button>
                <button class="template-btn" style="border-left:5px solid #eab308" onclick="loadIHKData('WISO')">‚öñÔ∏è WiSo Komplett</button>
                <button class="template-btn" style="border-left:5px solid #a855f7" onclick="loadAP2Smart()">üü™ AP2 Spezial (FISI / KIDG)</button>
            </div>
            
            <div id="uniTemplates" style="display:none;">
                <button class="template-btn" style="border-left:5px solid #10b981" onclick="loadUniData('INF_HWR')">üíª Informatik (HWR)</button>
                <button class="template-btn" style="border-left:5px solid #f59e0b" onclick="loadUniData('WI_HWR')">üìä W-Info (HWR)</button>
                <button class="template-btn" style="border-left:5px solid #3b82f6" onclick="loadUniData('WI_WILDAU')">üè≠ W-Info (Wildau)</button>
            </div>
            
            <label class="file-upload-label">
                üìÇ Eigene JSON Datei
                <input type="file" id="catalogImportInput" hidden accept=".json" onchange="handleCatalogImport(event)">
            </label>

            <button class="template-btn" style="text-align:center; margin-top:10px;" onclick="closeImport()">Abbrechen</button>
        </div>
    </div>

    <div id="toast">Info</div>

    <script>
        /* --- DATA --- */
        const IHK_FULL_DATA = [
          {"part": "AP1", "mod": "Projektmanagement", "task": "Merkmale eines Projektes"}, {"part": "AP1", "mod": "Projektmanagement", "task": "Projektplanung"}, {"part": "AP1", "mod": "IT-Systeme", "task": "Hardware Komponenten"},
          {"part": "WISO", "mod": "Recht", "task": "Arbeitsvertrag"}, {"part": "WISO", "mod": "Sozial", "task": "Versicherungen"},
          {"part": "AP2", "mod": "Netzwerke", "task": "IPv4 Subnetting", "job": "FISI"}, {"part": "AP2", "mod": "Server", "task": "Virtualisierung", "job": "FISI"},
          {"part": "AP2", "mod": "Prozesse", "task": "BPMN", "job": "KIDG"}, {"part": "AP2", "mod": "Rechnungswesen", "task": "KLR", "job": "KIDG"}
        ];

        const UNI_DATA = {
            "WI_HWR": [{"part": "Sem 1", "mod": "BWL", "task": "Grundlagen", "ects": 5}, {"part": "Sem 1", "mod": "IT", "task": "Java", "ects": 5}],
            "INF_HWR": [{"part": "Sem 1", "mod": "Mathe", "task": "Algebra", "ects": 7}, {"part": "Sem 1", "mod": "Prog", "task": "C", "ects": 5}],
            "WI_WILDAU": [{"part": "Sem 1", "mod": "BWL", "task": "Grundlagen", "ects": 5}]
        };

        let exams = [], tasks = [], cockpit = [], activeExamId = null, isUniMode = false, ganttView = 'all';
        let moduleSettings = {};

        // --- INIT ---
        window.onload = function() {
            try {
                exams = JSON.parse(localStorage.getItem('exams')) || [];
                tasks = JSON.parse(localStorage.getItem('wbsData')) || [];
                cockpit = JSON.parse(localStorage.getItem('cockpitTasks')) || [];
                moduleSettings = JSON.parse(localStorage.getItem('moduleSettings')) || {};
                activeExamId = localStorage.getItem('activeExamId');
                isUniMode = localStorage.getItem('isUniMode') === 'true';

                if (exams.length === 0) {
                    const id = 'ex-'+Date.now();
                    exams.push({id:id, name:'Meine Pr√ºfung', date:'', start: new Date().toISOString().split('T')[0]});
                    activeExamId = id;
                    save();
                } else if (!activeExamId || !exams.find(e => e.id === activeExamId)) { activeExamId = exams[0].id; }

                tasks.forEach(t => {
                    if (!t.part) t.part = t.examPart || "Allgemein";
                    if (!t.mod) t.mod = "Unsortiert";
                    if (!t.level) t.level = 0;
                    if (t.decayFlag === undefined) t.decayFlag = false;
                });

                if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
                applyDecay(); updateModeUI(); renderAll();
            } catch(e) { console.error(e); }
        };

        function save() {
            localStorage.setItem('exams', JSON.stringify(exams));
            localStorage.setItem('wbsData', JSON.stringify(tasks));
            localStorage.setItem('cockpitTasks', JSON.stringify(cockpit));
            localStorage.setItem('moduleSettings', JSON.stringify(moduleSettings));
            localStorage.setItem('activeExamId', activeExamId);
            localStorage.setItem('isUniMode', isUniMode);
        }

        function renderAll() { renderHeader(); renderCockpit(); renderBacklog(); renderPlan(); renderDashboard(); }

        /* --- IMPORT ENGINE (Unified) --- */
        function importEngine(items, defaultTime) {
            let added = 0;
            items.forEach(item => {
                const exists = tasks.some(t => t.examId === activeExamId && t.task === item.task);
                if (!exists) {
                    tasks.push({
                        id: Date.now() + Math.random(),
                        examId: activeExamId,
                        part: item.part || "Import",
                        mod: item.mod || "Sonstiges",
                        task: item.task,
                        status: 'todo',
                        imp: 5,
                        time: defaultTime || (isUniMode ? 60 : 30),
                        level: 0,
                        decayFlag: false
                    });
                    
                    // Uni ECTS Logic
                    if(isUniMode && item.ects && !moduleSettings[item.mod]) {
                         moduleSettings[item.mod] = { ects: item.ects, grade: '' };
                    }
                    added++;
                }
            });
            save(); renderAll(); closeImport();
            toast(`${added} Aufgaben importiert!`);
        }

        // Specific Loaders using Engine
        function loadIHKData(filterPart) {
            if(!confirm(`Katalog "${filterPart}" importieren?`)) return;
            const filtered = IHK_FULL_DATA.filter(i => i.part === filterPart);
            importEngine(filtered, 30);
        }

        function loadAP2Smart() {
            const job = prompt("Beruf?\n1=FISI, 2=FIAE, 3=KAUF");
            if(!job) return;
            const targetJob = (job==="1")?"FISI" : (job==="2")?"FIAE" : "KIDG"; // Fixed KIDG mapping
            
            const filtered = IHK_FULL_DATA.filter(i => {
                if(i.part !== "AP2") return false;
                return !i.job || i.job === targetJob;
            });
            importEngine(filtered, 30);
        }

        function loadUniData(key) {
            if(!confirm("Uni-Daten importieren?")) return;
            const data = UNI_DATA[key];
            if(data) importEngine(data, 60);
        }

        function handleCatalogImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) importEngine(data, 30);
                    else alert("Ung√ºltiges Format");
                } catch(err) { alert("Fehler"); }
            };
            reader.readAsText(file);
        }

        /* --- LOGIC & UI --- */
        function getInterval(l){ if(l===0)return 1;if(l===1)return 3;if(l===2)return 7;if(l===3)return 14;return 30;}
        function getDaysDiff(d){ if(!d)return 999; return Math.floor((new Date()-new Date(d))/(864e5));}
        function applyDecay(){
            let c=false; tasks.forEach(t=>{
                if(t.status==='done'&&t.lastReviewed){ if(getDaysDiff(t.lastReviewed)>getInterval(t.level)){t.status='doing';t.decayFlag=true;c=true;}}
                else if(t.status==='doing'&&t.lastReviewed){ if(getDaysDiff(t.lastReviewed)>7){t.status='todo';t.decayFlag=true;c=true;}}
            }); if(c){save();toast("Wiedervorlage aktualisiert");}
        }
        function dateToISO(s){if(!s)return "";const p=s.split(/[\.\/\-]/);if(p.length<3||p[0].length===4)return s;return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;}
        function isoToDisplay(s){if(!s)return "";const p=s.split('-');if(p.length<3)return s;return `${p[2]}.${p[1]}.${p[0]}`;}

        function renderHeader(){
            const s=document.getElementById('examSelect'); s.innerHTML='';
            exams.forEach(e=>{const o=document.createElement('option');o.value=e.id;o.text=e.name;if(e.id===activeExamId)o.selected=true;s.appendChild(o);});
            const ex=exams.find(e=>e.id===activeExamId);
            document.getElementById('daysLeft').innerText = (ex&&ex.date) ? (Math.ceil((new Date(ex.date)-new Date())/864e5)>0?`Noch ${Math.ceil((new Date(ex.date)-new Date())/864e5)} Tage`:"Vorbei") : "Kein Datum";
        }
        function switchExam(){ activeExamId=document.getElementById('examSelect').value; save(); renderAll(); }
        function addExam(){ const n=prompt("Name:");if(!n)return;const d=dateToISO(prompt("Datum (TT.MM.JJJJ):"));const s=dateToISO(prompt("Start (TT.MM.JJJJ):"));exams.push({id:'ex-'+Date.now(),name:n,date:d,start:s});activeExamId=exams[exams.length-1].id;save();renderAll(); }
        function editExam(){ const e=exams.find(x=>x.id===activeExamId);if(!e)return;const n=prompt("Name",e.name);if(n)e.name=n;const d=prompt("Datum",isoToDisplay(e.date));if(d)e.date=dateToISO(d);const s=prompt("Start",isoToDisplay(e.start));if(s)e.start=dateToISO(s);save();renderAll();}
        
        function renderCockpit(){
            const l=document.getElementById('cockpitList'); l.innerHTML='';
            const m=cockpit.filter(c=>c.examId===activeExamId);
            document.getElementById('emptyCockpit').style.display=m.length===0?'block':'none';
            m.forEach(c=>{
                const d=document.createElement('div'); d.className='cockpit-card'; if(c.done)d.style.opacity=0.5;
                d.innerHTML=`<div><div style="font-size:0.75rem;color:var(--primary);font-weight:bold;">${c.mod}</div><div style="font-weight:600;">${c.task}</div></div><div class="check-btn ${c.done?'checked':''}" onclick="toggleDone('${c.id}')">‚úì</div>`;
                l.appendChild(d);
            });
            const tot=tasks.filter(t=>t.examId===activeExamId).length; const don=tasks.filter(t=>t.examId===activeExamId&&t.status==='done').length;
            document.getElementById('progressText').innerText=tot>0?Math.round((don/tot)*100)+'%':'0%';
        }
        function toggleDone(id){
            const c=cockpit.find(x=>x.id===id); if(c){
                c.done=!c.done; const t=tasks.find(x=>x.id===c.originId);
                if(t){ if(c.done){ t.status='done'; t.lastReviewed=new Date().toISOString().split('T')[0]; t.level=(t.level||0)+1; t.decayFlag=false; } else { t.status='doing'; }}
                save(); renderAll();
                if(c.done) setTimeout(()=>{cockpit=cockpit.filter(x=>x.id!==id);save();renderCockpit();},800);
            }
        }
        function autoFill(){
            const p=tasks.filter(t=>t.examId===activeExamId&&t.status!=='done'&&!cockpit.some(c=>c.originId===t.id));
            if(p.length===0)return toast("Nichts gefunden.");
            p.slice(0,3).forEach(t=>{ cockpit.push({id:'cp-'+Math.random(),originId:t.id,examId:activeExamId,mod:t.mod,task:t.task,done:false}); t.status='doing'; });
            save(); renderAll(); toast("Gef√ºllt!");
        }

        function renderDashboard(){
            const ds=tasks.filter(t=>t.examId===activeExamId); const tot=ds.length;
            document.getElementById('uniStats').style.display=isUniMode?'block':'none';
            document.getElementById('statsDetails').style.display=isUniMode?'none':'block';
            if(tot===0){ document.getElementById('mainPercent').innerText="0%"; return;}
            const don=ds.filter(t=>t.status==='done').length; const perc=Math.round((don/tot)*100);
            document.getElementById('mainPieChart').style.background=`conic-gradient(var(--chart-done) 0deg ${Math.round(perc*3.6)}deg, var(--border) 0deg 360deg)`;
            document.getElementById('mainPercent').innerText=perc+"%";
            
            if(isUniMode){
                const mods=[...new Set(ds.map(t=>t.mod))].sort(); let h=''; let sumG=0, sumE=0, totE=0;
                mods.forEach(m=>{
                    const s=moduleSettings[m]||{ects:5,grade:''}; const e=parseFloat(s.ects)||0; const g=parseFloat(s.grade);
                    h+=`<tr><td>${m}</td><td><input type="number" value="${s.ects}" onchange="updMod('${m}','ects',this.value)"></td><td><input type="number" step="0.1" value="${s.grade}" placeholder="-" onchange="updMod('${m}','grade',this.value)"></td></tr>`;
                    totE+=e; if(g>0){sumG+=g*e; sumE+=e;}
                });
                document.getElementById('moduleTable').innerHTML=h;
                document.getElementById('gpaValue').innerText=sumE>0?(sumG/sumE).toFixed(1):"-";
                document.getElementById('ectsBar').style.width=(totE>0?(sumE/totE)*100:0)+"%";
                document.getElementById('ectsCount').innerText=`${sumE} / ${totE}`;
            } else {
                const parts={}; ds.forEach(t=>{const p=t.part||'Sonstiges'; if(!parts[p])parts[p]={t:0,d:0}; parts[p].t++; if(t.status==='done')parts[p].d++;});
                let h=''; for(const[k,v]of Object.entries(parts)){const p=Math.round((v.d/v.t)*100); h+=`<div class="progress-row"><div class="progress-header"><span>${k}</span><span>${v.d}/${v.t}</span></div><div class="progress-track"><div class="progress-fill" style="width:${p}%"></div></div></div>`;}
                document.getElementById('statsDetails').innerHTML=h;
            }
            const map={}; ds.forEach(t=>{if(t.status!=='done'){const m=t.mod||'Sonstiges'; map[m]=(map[m]||0)+1;}});
            const sort=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3);
            let ph=''; sort.forEach(([m,c])=>ph+=`<div class="stat-list-item"><span>${m}</span><span style="font-weight:bold;color:var(--danger)">${c} offen</span></div>`);
            document.getElementById('problemZonesList').innerHTML=ph||"<div style='text-align:center;color:var(--success)'>Alles sauber!</div>";
        }
        function updMod(m,f,v){ if(!moduleSettings[m])moduleSettings[m]={ects:5,grade:''}; moduleSettings[m][f]=v; save(); renderDashboard();}

        function renderBacklog(){
            const c=document.getElementById('backlogTree'); c.innerHTML='';
            let ds=tasks.filter(t=>t.examId===activeExamId);
            const ps=[...new Set(ds.map(t=>t.part))].sort(); const ms=[...new Set(ds.map(t=>t.mod))].sort();
            const sp=document.getElementById('filterPart'); const sm=document.getElementById('filterMod');
            const op=sp.value; const om=sm.value;
            sp.innerHTML='<option value="all">Alle Bereiche</option>'; ps.forEach(p=>sp.innerHTML+=`<option value="${p}">${p}</option>`); sp.value=ps.includes(op)?op:'all';
            sm.innerHTML='<option value="all">Alle Themen</option>'; ms.forEach(m=>sm.innerHTML+=`<option value="${m}">${m}</option>`); sm.value=ms.includes(om)?om:'all';
            if(sp.value!=='all')ds=ds.filter(t=>t.part===sp.value); if(sm.value!=='all')ds=ds.filter(t=>t.mod===sm.value);
            document.getElementById('emptyBacklog').style.display=ds.length===0?'block':'none';

            const gr={}; ds.forEach(t=>{if(!gr[t.part])gr[t.part]={}; if(!gr[t.part][t.mod])gr[t.part][t.mod]=[]; gr[t.part][t.mod].push(t);});

            for(const[p,mods]of Object.entries(gr)){
                const d1=document.createElement('details'); d1.className='tree-level-1'; d1.open=true;
                d1.innerHTML=`<summary style="justify-content:space-between"><span>${p}</span><button class="action-btn del" style="width:26px;height:26px" onclick="delPart('${p}',event)">√ó</button></summary>`;
                for(const[m,ts]of Object.entries(mods)){
                    const d2=document.createElement('details'); d2.className='tree-level-2'; d2.open=true;
                    d2.innerHTML=`<summary style="justify-content:space-between"><span style="display:flex;gap:8px;align-items:center">üìÇ ${m} <small>(${ts.length})</small></span><button class="action-btn del" style="width:26px;height:26px" onclick="delMod('${p}','${m}',event)">√ó</button></summary>`;
                    ts.forEach(t=>{
                        const r=document.createElement('div'); r.className='tree-item';
                        const pc=t.imp>=8?'red':(t.imp>=5?'orange':'green');
                        r.innerHTML=`<div class="status-dot ${t.status}" onclick="cycleStatus('${t.id}')"></div><div><input id="input-${t.id}" class="item-input" value="${t.task}" onchange="updTask('${t.id}','task',this.value)" onkeydown="checkEnter(event,'${p}','${m}')"><div class="item-meta-row"><span class="prio-dot" style="background:${pc}"></span><select class="mini-select" onchange="updTask('${t.id}','imp',this.value)"><option value="10" ${t.imp==10?'selected':''}>10</option><option value="8" ${t.imp==8?'selected':''}>8</option><option value="5" ${t.imp==5?'selected':''}>5</option><option value="3" ${t.imp==3?'selected':''}>3</option></select><span style="opacity:0.3">|</span><input type="number" class="mini-input" value="${t.time||30}" onchange="updTask('${t.id}','time',this.value)"> min</div></div><div style="display:flex;gap:5px"><button class="action-btn" onclick="toCockpit('${t.id}')">üöÄ</button><button class="action-btn" onclick="moveTask('${t.id}')">üìÇ</button><button class="action-btn del" onclick="delTask('${t.id}')">‚úï</button></div>`;
                        d2.appendChild(r);
                    });
                    d1.appendChild(d2);
                }
                c.appendChild(d1);
            }
        }
        
        function checkEnter(e,p,m){ if(e.key==='Enter'){ e.preventDefault(); const nid='t-'+Date.now(); tasks.push({id:nid,examId:activeExamId,part:p,mod:m,task:"",status:'todo',imp:5,time:30,level:0}); save(); renderAll(); setTimeout(()=>{const el=document.getElementById('input-'+nid);if(el)el.focus();},50); }}

        function addTask(){ const p=prompt("Bereich",document.getElementById('filterPart').value!=='all'?document.getElementById('filterPart').value:'Allgemein'); if(!p)return; const m=prompt("Thema",document.getElementById('filterMod').value!=='all'?document.getElementById('filterMod').value:'Unsortiert'); if(!m)return; tasks.push({id:'t-'+Date.now(),examId:activeExamId,part:p,mod:m,task:"Neu",status:'todo',imp:5,time:30,level:0}); save(); renderAll();}
        function cycleStatus(id){ const t=tasks.find(x=>x.id===id); if(t){ if(t.status==='todo')t.status='doing'; else if(t.status==='doing'){t.status='done';t.lastReviewed=new Date().toISOString().split('T')[0];t.level=(t.level||0)+1;}else t.status='todo'; save(); renderAll();}}
        function toCockpit(id){ if(cockpit.some(c=>c.originId===id))return toast("Schon geplant"); const t=tasks.find(x=>x.id===id); cockpit.push({id:'cp-'+Date.now(),originId:t.id,examId:activeExamId,mod:t.mod,task:t.task,done:false}); t.status='doing'; save(); renderAll(); toast("Geplant");}
        function delTask(id){ if(confirm("L√∂schen?")){tasks=tasks.filter(t=>t.id!==id);cockpit=cockpit.filter(c=>c.originId!==id);save();renderAll();}}
        function delPart(p,e){e.preventDefault();e.stopPropagation(); if(confirm("Bereich l√∂schen?")){const ids=tasks.filter(t=>t.part===p).map(t=>t.id); tasks=tasks.filter(t=>t.part!==p); cockpit=cockpit.filter(c=>!ids.includes(c.originId)); save(); renderAll();}}
        function delMod(p,m,e){e.preventDefault();e.stopPropagation(); if(confirm("Ordner l√∂schen?")){const ids=tasks.filter(t=>t.part===p&&t.mod===m).map(t=>t.id); tasks=tasks.filter(t=>!(t.part===p&&t.mod===m)); cockpit=cockpit.filter(c=>!ids.includes(c.originId)); save(); renderAll();}}
        function moveTask(id){const t=tasks.find(x=>x.id===id);const p=prompt("Bereich",t.part);if(p)t.part=p;const m=prompt("Thema",t.mod);if(m)t.mod=m;save();renderBacklog();}
        function updTask(id,f,v){const t=tasks.find(x=>x.id===id);if(t){t[f]=v;save();if(f==='imp')renderBacklog();}}

        function updateGanttView(){ ganttView=document.getElementById('ganttZoomSelect').value; renderPlan(); }
        function renderPlan(){
            const l=document.getElementById('agendaList'); const c=document.getElementById('ganttChart'); l.innerHTML=''; c.innerHTML='';
            const ve=exams.filter(e=>e.date).sort((a,b)=>new Date(a.date)-new Date(b.date));
            if(ve.length===0){c.innerHTML='<div style="text-align:center;padding:20px;color:#999">Keine Daten</div>';return;}
            ve.forEach(e=>{
                const bs=e.id===activeExamId?'border-left:4px solid var(--primary)':'border-left:4px solid #999';
                l.innerHTML+=`<div class="agenda-item" style="${bs}"><span><strong>${e.name}</strong><br><small>${isoToDisplay(e.start||'')} -> ${isoToDisplay(e.date)}</small></span><span>${getDaysDiff(e.date)} T</span></div>`;
            });
            const today=new Date(); let vs,ve_d;
            if(ganttView==='all'){ 
                let min=new Date(ve[0].start||today).getTime(), max=new Date(ve[ve.length-1].date).getTime();
                vs=new Date(min); vs.setDate(vs.getDate()-7); ve_d=new Date(max); ve_d.setDate(ve_d.getDate()+7);
            } else { vs=new Date(today); vs.setDate(vs.getDate()-3); ve_d=new Date(today); ve_d.setDate(ve_d.getDate()+parseInt(ganttView));}
            const tot=ve_d-vs;
            if(today>=vs&&today<=ve_d) c.innerHTML+=`<div class="today-line" style="left:${((today-vs)/tot)*100}%"></div>`;
            ve.forEach(e=>{
                const s=new Date(e.start||today), d=new Date(e.date); if(d<vs||s>ve_d)return;
                const L=Math.max(0,((s-vs)/tot)*100), W=Math.min(100,((d-vs)/tot)*100)-L;
                const col=e.id===activeExamId?'var(--primary)':'#94a3b8'; const op=e.id===activeExamId?'1':'0.5';
                c.innerHTML+=`<div class="bar-row"><div class="bar" style="left:${L}%;width:${W}%;background:${col};opacity:${op}">${e.name}</div></div>`;
            });
        }

        function toggleUniMode(){ isUniMode=!isUniMode; save(); updateModeUI(); renderAll(); toast(isUniMode?"Uni":"IHK");}
        function updateModeUI(){ document.getElementById('modeBadge').innerText=isUniMode?"Student":"Azubi"; document.getElementById('footerMode').innerText=isUniMode?"Uni":"IHK"; document.getElementById('ihkTemplates').style.display=isUniMode?'none':'block'; document.getElementById('uniTemplates').style.display=isUniMode?'block':'none';}
        function openImport(){ document.getElementById('importModal').style.display='flex'; }
        function closeImport(){ document.getElementById('importModal').style.display='none'; }
        
        function showTab(id){ document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById('btn-'+id).classList.add('active'); if(id==='plan')renderPlan();}
        function toggleDark(){ document.body.classList.toggle('dark-mode'); localStorage.setItem('theme',document.body.classList.contains('dark-mode')?'dark':'light'); }
        function toast(m){ const t=document.getElementById('toast');t.innerText=m;t.className='show';setTimeout(()=>t.className='',2000); }
        function downloadBackup(){ const d={exams,tasks,cockpit,activeExamId,isUniMode,moduleSettings}; const b=new Blob([JSON.stringify(d)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click(); }
        function restoreBackup(){ document.getElementById('fileInput').click(); }
        function loadFile(e){ const fr=new FileReader(); fr.onload=(ev)=>{try{const d=JSON.parse(ev.target.result); exams=d.exams||[]; tasks=d.tasks||[]; cockpit=d.cockpit||[]; activeExamId=d.activeExamId; isUniMode=d.isUniMode; moduleSettings=d.moduleSettings||{}; save(); location.reload();}catch(x){alert("Fehler")}}; fr.readAsText(e.target.files[0]); }
        function hardReset(){ if(confirm("Alles l√∂schen?")){localStorage.clear(); location.reload();} }
    </script>
</body>
</html>
